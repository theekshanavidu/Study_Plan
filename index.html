<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Time Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ---------- Firebase Config ----------
const firebaseConfig = {
    apiKey: "AIzaSyDYhulc8Qz_xGfIeb1g9A6BGO2wwbrz82M",
    authDomain: "study-9c374.firebaseapp.com",
    projectId: "study-9c374",
    storageBucket: "study-9c374.appspot.com",
    messagingSenderId: "82946998504",
    appId: "1:82946998504:web:290cd36a2559846891095d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- Admin UID ----------
const ADMIN_UID = "m1rddMA36WbVunFW3B0BzuqOwyI2";

let currentUser = null;
const appContainer = document.getElementById('app-container');
const headerGreeting = document.getElementById('header-greeting');
const headerButtons = document.getElementById('header-buttons');

// ---------- Greeting ----------
function getGreeting(name){
  const h = new Date().getHours();
  let greeting = h < 12 ? "Good Morning" : h < 17 ? "Good Afternoon" : "Good Evening";
  return name ? `${greeting} ${name}` : greeting;
}
function updateGreeting(){
  const name = currentUser?.displayName;
  const now = new Date();
  headerGreeting.textContent = `${getGreeting(name)} | ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(updateGreeting, 1000);

// ---------- Auth Listener ----------
onAuthStateChanged(auth, u=>{
  currentUser = u;
  if(currentUser && currentUser.uid===ADMIN_UID) currentUser.displayName="Admin";
  renderHeader();
  if(currentUser) renderHome();
  else renderWelcome();
});

// ---------- Header ----------
function renderHeader(){
  headerButtons.innerHTML='';
  if(currentUser){
    // Logout
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent='Logout';
    logoutBtn.className='px-4 py-2 border-2 border-indigo-400 rounded-2xl neon-btn';
    logoutBtn.onclick=async()=>await signOut(auth);
    headerButtons.appendChild(logoutBtn);

    // Profile
    const profileBtn = document.createElement('button');
    profileBtn.textContent='Profile';
    profileBtn.className='px-4 py-2 border-2 border-pink-400 rounded-2xl neon-btn';
    profileBtn.onclick=()=>renderProfile();
    headerButtons.appendChild(profileBtn);

    // Admin Panel
    if(currentUser.uid===ADMIN_UID){
      const adminBtn = document.createElement('button');
      adminBtn.textContent='Admin Panel';
      adminBtn.className='px-4 py-2 border-2 border-green-400 rounded-2xl neon-btn';
      adminBtn.onclick=()=>renderAdmin();
      headerButtons.appendChild(adminBtn);
    }

  }else{
    // Login
    const loginBtn = document.createElement('button');
    loginBtn.textContent='Login';
    loginBtn.className='px-4 py-2 border-2 border-indigo-400 rounded-2xl neon-btn';
    loginBtn.onclick=()=>renderLogin();
    headerButtons.appendChild(loginBtn);

    // Register
    const regBtn = document.createElement('button');
    regBtn.textContent='Register';
    regBtn.className='px-4 py-2 border-2 border-pink-400 rounded-2xl neon-btn';
    regBtn.onclick=()=>renderRegister();
    headerButtons.appendChild(regBtn);
  }
}

// ---------- Welcome ----------
function renderWelcome(){
  appContainer.innerHTML=`
  <div class="text-center space-y-4">
    <h2 class="text-3xl">Welcome to Study Tracker</h2>
    <div class="flex justify-center gap-4 mt-4 flex-wrap">
      <button class="px-6 py-2 border-2 border-indigo-400 rounded-2xl neon-btn" onclick="renderLogin()">Login</button>
      <button class="px-6 py-2 border-2 border-pink-400 rounded-2xl neon-btn" onclick="renderRegister()">Register</button>
    </div>
  </div>`;
}

// ---------- Register ----------
function renderRegister(){
  appContainer.innerHTML=`
  <div class="bg-slate-800 p-6 rounded-xl space-y-3">
    <h2 class="text-2xl">Register</h2>
    <form id="reg-form">
      <input type="text" name="firstName" placeholder="First Name" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="text" name="lastName" placeholder="Last Name" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="date" name="birthday" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="text" name="school" placeholder="School" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="text" name="phone" placeholder="Phone" class="p-2 bg-slate-700 rounded w-full" required>
      <select name="examYear" class="p-2 bg-slate-700 rounded w-full" required>
        <option>2026 A/L</option>
        <option>2027 A/L</option>
        <option>2028 A/L</option>
      </select>
      <input type="email" name="email" placeholder="Email" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="password" name="password" placeholder="Password" class="p-2 bg-slate-700 rounded w-full" required>
      <button type="submit" class="px-4 py-2 border-2 border-pink-400 rounded-2xl neon-btn w-full">Register</button>
      <div id="reg-error" class="text-red-400"></div>
    </form>
  </div>`;

  document.getElementById('reg-form').onsubmit=async e=>{
    e.preventDefault();
    const f=e.target;
    try{
      const cred = await createUserWithEmailAndPassword(auth,f.email.value,f.password.value);
      await updateProfile(cred.user,{displayName:f.firstName.value + ' ' + f.lastName.value});
      await setDoc(doc(db,'users',cred.user.uid),{
        firstName:f.firstName.value,
        lastName:f.lastName.value,
        birthday:f.birthday.value,
        school:f.school.value,
        phone:f.phone.value,
        examYear:f.examYear.value,
        email:f.email.value,
        createdAt:new Date().toISOString()
      });
    }catch(err){
      document.getElementById('reg-error').textContent=err.message;
    }
  }
}

// ---------- Login ----------
function renderLogin(){
  appContainer.innerHTML=`
  <div class="bg-slate-800 p-6 rounded-xl space-y-3">
    <h2 class="text-2xl">Login</h2>
    <form id="login-form">
      <input type="email" name="email" placeholder="Email" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="password" name="password" placeholder="Password" class="p-2 bg-slate-700 rounded w-full" required>
      <div class="flex justify-between items-center mt-2">
        <button type="submit" class="px-4 py-2 border-2 border-indigo-400 rounded-2xl neon-btn">Login</button>
        <button type="button" id="forgot-pass" class="text-sm text-slate-300">Forgot?</button>
      </div>
      <div id="login-error" class="text-red-400"></div>
    </form>
  </div>`;

  document.getElementById('login-form').onsubmit=async e=>{
    e.preventDefault();
    const f=e.target;
    try{ await signInWithEmailAndPassword(auth,f.email.value,f.password.value); }
    catch(err){ document.getElementById('login-error').textContent=err.message; }
  }

  document.getElementById('forgot-pass').onclick=async ()=>{
    const email = prompt('Enter your email to reset password:');
    if(email){
      try{ await sendPasswordResetEmail(auth,email); alert('Check your email'); }
      catch(err){ alert(err.message); }
    }
  }
}

// ---------- Home ----------
async function renderHome(){
  appContainer.innerHTML=`
  <div class="space-y-4">
    <h2 class="text-2xl">Daily Entry</h2>
    <form id="daily-form" class="space-y-2">
      <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" class="p-2 bg-slate-700 rounded w-full" required>
      <input type="number" name="hours" placeholder="Hours studied" min="0" max="24" class="p-2 bg-slate-700 rounded w-full" required>
      <button class="px-4 py-2 border-2 border-indigo-400 rounded-2xl neon-btn w-full">Save</button>
      <div id="daily-msg" class="text-green-400"></div>
    </form>
    <h2 class="text-2xl mt-4">Weekly Chart</h2>
    <canvas id="weekly-chart" class="bg-slate-800 rounded p-2"></canvas>
    <h2 class="text-2xl mt-4">Monthly Chart</h2>
    <canvas id="monthly-chart" class="bg-slate-800 rounded p-2"></canvas>
  </div>`;

  document.getElementById('daily-form').onsubmit=async e=>{
    e.preventDefault();
    const f=e.target;
    try{
      await addDoc(collection(db,'studyLogs'),{
        userId: currentUser.uid,
        date:f.date.value,
        hours:Number(f.hours.value),
        createdAt:new Date().toISOString()
      });
      document.getElementById('daily-msg').textContent='Saved!';
      renderCharts();
    }catch(err){ document.getElementById('daily-msg').textContent=err.message; }
  }
  renderCharts();
}

// ---------- Charts ----------
async function renderCharts(){
  const snap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',currentUser.uid)));
  const data = snap.docs.map(d=>d.data());
  const weekly=[], monthly={};
  const today=new Date();

  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(today.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    weekly.push(data.filter(x=>x.date===ds).reduce((a,b)=>a+b.hours,0));
  }

  data.forEach(x=>{
    const month=x.date.slice(0,7);
    monthly[month]=(monthly[month]||0)+x.hours;
  });

  const ctxW=document.getElementById('weekly-chart').getContext('2d');
  new Chart(ctxW,{type:'line',data:{labels:Array.from({length:7},(_,i)=>{const d=new Date(); d.setDate(today.getDate()-6+i); return d.toISOString().slice(5,10);}),datasets:[{label:'Hours',data:weekly,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.3)',fill:true}]},options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});

  const ctxM=document.getElementById('monthly-chart').getContext('2d');
  new Chart(ctxM,{type:'line',data:{labels:Object.keys(monthly),datasets:[{label:'Hours',data:Object.values(monthly),borderColor:'#22d3ee',backgroundColor:'rgba(34,211,238,0.3)',fill:true}]} ,options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});
}

// ---------- Profile ----------
async function renderProfile(){
  if(currentUser.uid===ADMIN_UID){ alert('Admin has no personal profile'); return; }
  const snap = await getDoc(doc(db,'users',currentUser.uid));
  if(!snap.exists()){ alert('Profile not found'); return; }
  const u = snap.data();
  appContainer.innerHTML=`
  <div class="bg-slate-800 p-6 rounded-xl space-y-2">
    <h2 class="text-2xl">${u.firstName} ${u.lastName}</h2>
    <p>Birthday: ${u.birthday}</p>
    <p>School: ${u.school}</p>
    <p>Exam Year: ${u.examYear}</p>
    <p>Phone: ${u.phone}</p>
    <p>Email: ${u.email}</p>
  </div>`;
}

// ---------- Admin Panel ----------
async function renderAdmin(){
  if(!currentUser || currentUser.uid!==ADMIN_UID){ alert("Access Denied"); return; }
  appContainer.innerHTML=`<h2 class="text-2xl mb-4">Admin Panel</h2>
    <div id="admin-users" class="space-y-2"></div>
    <div id="admin-user-details" class="mt-6"></div>`;

  const usersContainer = document.getElementById('admin-users');
  usersContainer.innerHTML='Loading users...';

  const usersSnap = await getDocs(collection(db,'users'));
  usersContainer.innerHTML='';

  usersSnap.docs.forEach(docSnap=>{
    const u=docSnap.data();
    const div=document.createElement('div');
    div.className='bg-slate-800 p-3 rounded flex justify-between items-center';
    div.innerHTML=`
      <div>
        <strong>${u.firstName} ${u.lastName}</strong> (${u.email})<br>
        School: ${u.school || '-'} • Exam: ${u.examYear || '-'}
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1 border-2 border-blue-400 rounded-2xl neon-btn">View</button>
        <button class="px-3 py-1 border-2 border-red-400 rounded-2xl neon-btn">Delete</button>
      </div>
    `;
    div.querySelector('button:nth-child(1)').onclick=()=>renderAdminUserDetails(docSnap.id);
    div.querySelector('button:nth-child(2)').onclick=async ()=>{
      if(confirm(`Delete user ${u.firstName} ${u.lastName}?`)){
        await deleteDoc(doc(db,'users',docSnap.id));
        renderAdmin();
      }
    };
    usersContainer.appendChild(div);
  });
}

// ---------- Admin User Details + Charts ----------
async function renderAdminUserDetails(uid){
  const detailsContainer = document.getElementById('admin-user-details');
  const userSnap = await getDoc(doc(db,'users',uid));
  if(!userSnap.exists()){ detailsContainer.innerHTML='User not found'; return; }
  const u=userSnap.data();
  const logsSnap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',uid)));
  const logs = logsSnap.docs.map(d=>d.data());

  const weeklyData=[], today=new Date();
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(today.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    weeklyData.push(logs.filter(x=>x.date===ds).reduce((a,b)=>a+b.hours,0));
  }

  const monthly={};
  logs.forEach(x=>{
    const month=x.date.slice(0,7);
    monthly[month]=(monthly[month]||0)+x.hours;
  });

  detailsContainer.innerHTML=`
  <div class="bg-slate-800 p-4 rounded space-y-3">
    <h3 class="text-xl">${u.firstName} ${u.lastName}</h3>
    <p>Email: ${u.email}</p>
    <p>Birthday: ${u.birthday}</p>
    <p>School: ${u.school}</p>
    <p>Exam: ${u.examYear}</p>
    <p>Phone: ${u.phone}</p>

    <h4 class="mt-4">Weekly Study Hours</h4>
    <canvas id="admin-weekly-chart" class="bg-slate-700 rounded p-2"></canvas>

    <h4 class="mt-4">Monthly Study Hours</h4>
    <canvas id="admin-monthly-chart" class="bg-slate-700 rounded p-2"></canvas>
  </div>
  `;

  const ctxW=document.getElementById('admin-weekly-chart').getContext('2d');
  new Chart(ctxW,{type:'line',data:{labels:Array.from({length:7},(_,i)=>{const d=new Date(); d.setDate(today.getDate()-6+i); return d.toISOString().slice(5,10);}),datasets:[{label:'Hours',data:weeklyData,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.3)',fill:true}]} ,options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});

  const ctxM=document.getElementById('admin-monthly-chart').getContext('2d');
  new Chart(ctxM,{type:'line',data:{labels:Object.keys(monthly),datasets:[{label:'Hours',data:Object.values(monthly),borderColor:'#22d3ee',backgroundColor:'rgba(34,211,238,0.3)',fill:true}]} ,options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});
}

</script>

<style>
.neon-btn{ cursor:pointer; transition:all 0.2s; }
.neon-btn:hover{ box-shadow:0 0 10px #8b5cf6,0 0 20px #8b5cf6,0 0 30px #8b5cf6;}
</style>
</head>
<body class="bg-black text-slate-100 min-h-screen flex flex-col items-center justify-start p-4">

<header class="w-full p-4 bg-gradient-to-r from-slate-900 via-indigo-900 to-slate-900 shadow-lg flex justify-between items-center flex-wrap">
  <h1 class="text-2xl font-bold">StudyTracker</h1>
  <div id="header-greeting" class="text-lg"></div>
  <div id="header-buttons" class="flex gap-2 flex-wrap"></div>
</header>

<main class="flex-1 w-full max-w-xl mt-4" id="app-container"></main>

<footer class="text-sm text-slate-400 mt-4 w-full text-center">
  © Theekshana Viduranga | Contact: 0714667630
</footer>

</body>
</html>
